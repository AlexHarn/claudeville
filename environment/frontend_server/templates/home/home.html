{% extends "base.html" %}
{% load static %}

{% block content %}
<!-- Game fills entire screen -->
<div id="game-container"></div>

<!-- Hidden data elements for JavaScript -->
<div id="step" class="hidden-data">{{step}}</div>
<div id="sim_code" class="hidden-data">{{sim_code}}</div>
<div id="persona_name_list" class="hidden-data">{{persona_name_str}}</div>
<div id="persona_init_pos" class="hidden-data">
  {% for i in persona_init_pos %}
    <span>{{i.0}},{{i.1}},{{i.2}}</span>
  {% endfor %}
</div>

<!-- Top Bar - Time and Controls -->
<div id="control-bar" class="ui-overlay top-bar">
  <div class="time-display">
    <span id="game-time-content">--:--</span>
  </div>
  <div class="control-buttons">
    <button id="play_button" class="control-btn" title="Play">
      <span class="icon">▶</span>
    </button>
    <button id="pause_button" class="control-btn" title="Pause">
      <span class="icon">⏸</span>
    </button>
    <button id="skip_button" class="control-btn" title="Skip to next action">
      <span class="icon">⏭</span>
    </button>
  </div>
  <div class="speed-control">
    <label for="speed_slider">Speed:</label>
    <input type="range" id="speed_slider" min="1" max="50" value="5">
    <span id="speed_label">5x</span>
  </div>
  <div class="zoom-display">
    <span>Zoom:</span>
    <span id="zoom-indicator">100%</span>
  </div>
</div>

<!-- Persona Panel - Collapsible Side Panel -->
<div id="persona-panel" class="ui-overlay side-panel">
  <div class="panel-header">
    <span>Personas</span>
    <button id="toggle-panel" class="toggle-btn">▶</button>
  </div>
  <div class="panel-content">
    {% for p_name, p_name_os in persona_names %}
    <div class="persona-card" id="card__{{ p_name_os }}" data-persona-name="{{ p_name }}">
      <div class="persona-avatar">
        <img src="{% static 'assets/characters/' %}{{ p_name_os }}.png"
             onerror="this.src='{% static 'img/atlas.png' %}';">
      </div>
      <div class="persona-info">
        <div class="persona-name" id="name__{{ p_name_os }}">{{ p_name }}</div>
        <div class="persona-action">
          <span class="label">Action:</span>
          <span id="current_action__{{ p_name_os }}">-</span>
        </div>
        <div class="persona-location">
          <span class="label">Location:</span>
          <span id="target_address__{{ p_name_os }}">-</span>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Simulation Status Indicator -->
<div id="sim-status" class="ui-overlay sim-status">
  <span id="sim-status-text">Ready</span>
  <div id="sim-progress" class="sim-progress-bar"></div>
</div>

<!-- Chat Popup - Bottom Center Conversation Display -->
<div id="chat-popup" class="ui-overlay chat-popup hidden">
  <div class="chat-header">
    <div class="chat-tabs" id="chat-tabs">
      <!-- Dynamically populated -->
    </div>
    <button class="chat-minimize" id="chat-minimize">−</button>
  </div>
  <div class="chat-messages" id="chat-messages">
    <!-- Dynamically populated -->
  </div>
</div>

<!-- Menu Overlay (ESC to toggle) -->
<div id="menu-overlay" class="menu-overlay hidden">
  <div class="menu-panel">
    <h2>Menu</h2>
    <div class="menu-section">
      <h3>Current Simulation</h3>
      <p id="menu-sim-info">--</p>
    </div>
    <div class="menu-buttons">
      <button id="menu-save-btn" class="menu-btn">Save Game</button>
      <button id="menu-resume-btn" class="menu-btn primary">Resume</button>
    </div>
    <div class="menu-section">
      <h3>Saved Games</h3>
      <div id="saves-list" class="saves-list">
        <p class="saves-loading">Loading...</p>
      </div>
    </div>
    <p class="menu-hint">Press ESC to close</p>
  </div>
</div>

<script src='https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js'></script>
{% include 'home/main_script.html' %}
{% endblock content %}
